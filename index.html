<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猷 & 玲 總資產管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 0.875rem; }
        .section-title { font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; border-left: 3px solid #3b82f6; padding-left: 8px; margin-bottom: 12px; }
        .btn-action { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.4); color: #60a5fa; padding: 6px 16px; border-radius: 99px; font-size: 0.75rem; transition: all 0.3s; font-weight: 600; }
        .btn-action:hover { background: #3b82f6; color: white; }
        .btn-add { background: rgba(255, 255, 255, 0.05); color: #94a3b8; border: 1px solid rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 10px; }
        .btn-delete { color: #ef4444; cursor: pointer; padding: 0 8px; }
        .drag-handle { color: #475569; cursor: grab; padding: 0 4px; font-size: 14px; user-select: none; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.3; background: #3b82f6 !important; }
        .usd-label { font-size: 10px; color: #60a5fa; margin-top: 2px; padding-right: 32px; text-align: right; width: 100%; display: block; font-family: monospace; }
        .stock-label { font-size: 9px; color: #94a3b8; margin-bottom: 4px; display: block; font-weight: bold; }
        #history-container table { width: 100%; border-collapse: collapse; }
        #history-container th, #history-container td { padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        #history-container th { font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        #history-container td { font-family: monospace; font-size: 14px; }

        @media (max-width: 640px) {
            #history-table thead { display: none; }
            #history-table-body { display: flex; flex-direction: column; gap: 16px; padding: 10px 4px; }
            #history-table-body tr { display: block; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            #history-table-body td { display: flex; justify-content: space-between; align-items: center; padding: 6px 0 !important; border: none !important; font-size: 15px !important; }
            #history-table-body td:nth-child(1) { font-size: 18px !important; border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important; margin-bottom: 8px; padding-bottom: 10px !important; color: #fff !important; }
            #history-table-body td:nth-child(1)::before { content: "結算日期"; font-size: 10px; color: #3b82f6; text-transform: uppercase; letter-spacing: 1px; }
            #history-table-body td:not(:first-child)::before { content: attr(data-label); font-size: 12px; color: #94a3b8; font-weight: normal; font-family: sans-serif; }
        }
        .hidden { display: none; }
    </style>
</head>
<body class="gradient-bg text-slate-200 min-h-screen p-4 md:p-8 font-sans">
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/10 pb-8 gap-8">
            <div class="flex flex-col items-center md:items-start">
                <h1 class="text-xl font-bold tracking-widest text-white mb-2">總資產管理系統</h1>
                <div class="flex items-center gap-6">
                    <button onclick="togglePage('edit')" id="nav-edit" class="text-xs font-bold text-blue-400 border-b-2 border-blue-400 pb-1 transition-all">資產編輯</button>
                    <button onclick="togglePage('history')" id="nav-history" class="text-xs font-bold text-slate-500 hover:text-white pb-1 transition-all">歷史紀錄</button>
                </div>
            </div>
            <div class="flex gap-12">
                <div class="text-center">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1 tracking-wider">現有存款</span>
                    <span id="global-bank-sum" class="text-2xl font-mono font-bold text-emerald-400">0</span>
                </div>
                <div class="text-center">
                    <span class="text-[10px] text-blue-300 uppercase block mb-1 tracking-wider">現有總資產</span>
                    <span id="global-asset-sum" class="text-2xl font-mono font-bold text-white">0</span>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <div class="text-center mb-6"> <span class="text-[10px] text-slate-500 uppercase block mb-0.5 tracking-wider">USD/TWD 參考匯率</span>
                    <span id="fx-rate-display" class="text-lg text-white font-mono font-bold">--.--</span>
                </div>
                <div class="flex flex-col items-center">
                    <button onclick="saveData()" class="btn-action tracking-widest uppercase px-10">儲存並更新</button>
                    <span id="sync-status" class="text-[9px] uppercase font-bold text-slate-500 mt-2 text-center block">系統就緒</span>
                </div>
            </div>
        </header>

        <div id="page-edit" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white tracking-widest">猷</h2>
                    <span id="you-total" class="font-mono text-white font-bold text-lg">0</span>
                </div>
                <div class="section-title">銀行存款</div>
                <div id="you-bank-list" class="space-y-2 mb-4"></div>
                <button onclick="addRow('you-bank-list')" class="btn-add">+ 新增銀行</button>
                <div class="section-title mt-8">股票庫存</div>
                <div class="grid grid-cols-2 gap-4">
                    <div><span class="stock-label">台股市值 (TWD)</span><input type="number" id="you-stock-tw" class="input-field font-mono" oninput="calculate()"></div>
                    <div><span class="stock-label">美股市值 (USD)</span><input type="number" id="you-stock-us" class="input-field font-mono text-blue-400" oninput="calculate()"></div>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 text-right">美股折合 TWD: <span id="you-stock-us-twd">0</span></p>
            </div>

            <div class="card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white tracking-widest">玲</h2>
                    <span id="ling-total" class="font-mono text-white font-bold text-lg">0</span>
                </div>
                <div class="section-title">銀行存款</div>
                <div id="ling-bank-list" class="space-y-2 mb-4"></div>
                <button onclick="addRow('ling-bank-list')" class="btn-add">+ 新增銀行</button>
                <div class="section-title mt-8">股票庫存</div>
                <div class="grid grid-cols-2 gap-4">
                    <div><span class="stock-label">台股市值 (TWD)</span><input type="number" id="ling-stock-1" class="input-field font-mono" oninput="calculate()"></div>
                    <div><span class="stock-label">雄獅配股市值 (TWD)</span><input type="number" id="ling-stock-2" class="input-field font-mono" oninput="calculate()"></div>
                </div>
            </div>

            <div class="lg:col-span-2 card p-6 rounded-2xl border-t-2 border-red-500/50">
                <h2 class="text-xs font-bold text-white tracking-widest mb-6 uppercase">貸款負債管理</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div class="flex justify-between items-center mb-2"><span class="text-[10px] text-slate-500 uppercase">房貸明細</span><span id="loan-house-sum" class="font-mono text-red-400">0</span></div>
                        <div id="loan-house-list" class="space-y-2"></div>
                        <button onclick="addRow('loan-house-list', '房貸名稱')" class="btn-add mt-2">+ 房貸</button>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2"><span class="text-[10px] text-slate-500 uppercase">信貸明細</span><span id="loan-credit-sum" class="font-mono text-red-400">0</span></div>
                        <div id="loan-credit-list" class="space-y-2"></div>
                        <button onclick="addRow('loan-credit-list', '信貸名稱')" class="btn-add mt-2">+ 信貸</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 card p-6 rounded-2xl border-t-2 border-emerald-500/50">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-xs font-bold text-white tracking-widest uppercase">月底資產結算</h2>
                    <span class="text-[10px] text-slate-500">上次結算值: <span id="last-month-val">0</span></span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-black/20 p-3 rounded-lg"><label class="text-[9px] text-slate-500 block uppercase">結算日期</label><input type="date" id="archive-date" class="bg-transparent text-white font-mono text-xs w-full outline-none"></div>
                    <div class="bg-black/20 p-3 rounded-lg"><label class="text-[9px] text-slate-500 block uppercase">淨資產(扣所有)</label><div id="res-net" class="font-mono text-sm font-bold text-blue-400">0</div></div>
                    <div class="bg-black/20 p-3 rounded-lg"><label class="text-[9px] text-slate-500 block uppercase">淨資產(扣房貸)</label><div id="res-excl" class="font-mono text-sm font-bold text-emerald-400">0</div></div>
                    <div class="bg-black/20 p-3 rounded-lg"><label class="text-[9px] text-slate-500 block uppercase">本月增減</label><div id="res-diff" class="font-mono text-sm font-bold">0</div></div>
                </div>
                <div class="mb-6">
                    <label class="text-[9px] text-slate-500 block uppercase mb-1">本月結算備註</label>
                    <textarea id="archive-note" class="input-field w-full h-16 text-xs bg-black/20" placeholder="例如：首爾旅遊、網球學費..."></textarea>
                </div>
                <div class="flex justify-center">
                    <button onclick="archiveHistory()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-12 py-3 rounded-xl text-sm font-black tracking-[0.2em] transition-all shadow-lg shadow-emerald-900/20 active:scale-95">確認結算</button>
                </div>
            </div>
        </div>

        <div id="page-history" class="hidden">
            <div class="card p-4 md:p-6 rounded-2xl" id="history-container">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 px-2 gap-4">
                    <h2 class="text-xl font-bold text-white tracking-widest">歷史紀錄</h2>
                    <div class="flex gap-2">
                        <button onclick="exportToExcel()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-[10px] font-bold tracking-widest transition-all">匯出 EXCEL 報表</button>
                        <button onclick="loadHistoryTable()" class="btn-action text-[10px]">重新整理</button>
                    </div>
                </div>
                <div class="overflow-hidden">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>總資產</th>
                                <th>存款</th>
                                <th>淨資產(扣所有)</th>
                                <th>淨資產(扣房貸)</th>
                                <th>增減</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzT-nQswx9GUQ8JHEp1zpr4HDXSHrz7s8kTqIe3FD9eUzqqNb7UlBGnSGoLqInyQ3i1/exec'; 
        let currentFxRate = 32.5;
        let lastMonthNetExclHouse = 0;
        let fetchedHistory = [];

        function initSortable(id) {
            new Sortable(document.getElementById(id), {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => calculate()
            });
        }

        function togglePage(page) {
            const isHistory = (page === 'history');
            document.getElementById('page-edit').classList.toggle('hidden', isHistory);
            document.getElementById('page-history').classList.toggle('hidden', !isHistory);
            document.getElementById('nav-history').className = isHistory ? "text-xs font-bold text-blue-400 border-b-2 border-blue-400 pb-1" : "text-xs font-bold text-slate-500 hover:text-white pb-1";
            document.getElementById('nav-edit').className = !isHistory ? "text-xs font-bold text-blue-400 border-b-2 border-blue-400 pb-1" : "text-xs font-bold text-slate-500 hover:text-white pb-1";
            if (isHistory) loadHistoryTable();
        }

        async function fetchFxRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if (data && data.rates.TWD) {
                    currentFxRate = data.rates.TWD;
                    document.getElementById('fx-rate-display').innerText = currentFxRate.toFixed(2);
                    calculate();
                }
            } catch (e) { document.getElementById('fx-rate-display').innerText = "32.50"; }
        }

        function addRow(containerId, placeholder = '項目名稱', name = '', amount = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = "flex flex-col mb-3";
            const valAttr = (amount === '' || amount === 0 || amount === '0') ? '' : `value="${amount}"`;
            div.innerHTML = `
                <div class="flex gap-2 items-center">
                    <span class="drag-handle">≡</span>
                    <input type="text" class="input-field text-xs item-name" value="${name}" placeholder="${placeholder}">
                    <input type="number" class="input-field w-32 font-mono text-right text-xs item-amount" ${valAttr} placeholder="金額" oninput="calculate()">
                    <span class="btn-delete text-[10px]" onclick="this.parentElement.parentElement.remove(); calculate();">✕</span>
                </div>
                <span class="usd-hint usd-label hidden"></span>
            `;
            container.appendChild(div);
            calculate();
        }

        function calculate() {
            function getSums(selector) {
                let currentSum = 0;
                document.querySelectorAll(selector).forEach(parent => {
                    const nameEl = parent.querySelector('.item-name');
                    const amountInput = parent.querySelector('.item-amount');
                    const hint = parent.querySelector('.usd-hint');
                    if (!nameEl || !amountInput) return;
                    const name = nameEl.value;
                    let val = parseFloat(amountInput.value) || 0;
                    let finalTwd = val;
                    if (name.includes("美金定存")) {
                        finalTwd = val * currentFxRate;
                        if (val > 0) {
                            hint.innerText = `≈ TWD ${Math.floor(finalTwd).toLocaleString()}`;
                            hint.classList.remove('hidden');
                        } else { hint.classList.add('hidden'); }
                    } else { hint.classList.add('hidden'); }
                    if (!name.includes("玲媽未投")) { currentSum += finalTwd; }
                });
                return currentSum;
            }
            const youBank = getSums('#you-bank-list > div');
            const youStockTW = parseFloat(document.getElementById('you-stock-tw').value) || 0;
            const youStockUS = parseFloat(document.getElementById('you-stock-us').value) || 0;
            const youStockUS_TWD = youStockUS * currentFxRate;
            document.getElementById('you-stock-us-twd').innerText = Math.floor(youStockUS_TWD).toLocaleString();
            const youTotal = youBank + youStockTW + youStockUS_TWD;
            document.getElementById('you-total').innerText = Math.floor(youTotal).toLocaleString();
            const lingBank = getSums('#ling-bank-list > div');
            const lingStock1 = parseFloat(document.getElementById('ling-stock-1').value) || 0;
            const lingStock2 = parseFloat(document.getElementById('ling-stock-2').value) || 0;
            const lingTotal = lingBank + lingStock1 + lingStock2;
            document.getElementById('ling-total').innerText = Math.floor(lingTotal).toLocaleString();
            let house = 0; document.querySelectorAll('#loan-house-list .item-amount').forEach(el => house += parseFloat(el.value) || 0);
            document.getElementById('loan-house-sum').innerText = Math.floor(house).toLocaleString();
            let credit = 0; document.querySelectorAll('#loan-credit-list .item-amount').forEach(el => credit += parseFloat(el.value) || 0);
            document.getElementById('loan-credit-sum').innerText = Math.floor(credit).toLocaleString();
            const totalBank = youBank + lingBank;
            const totalAsset = youTotal + lingTotal;
            document.getElementById('global-bank-sum').innerText = Math.floor(totalBank).toLocaleString();
            document.getElementById('global-asset-sum').innerText = Math.floor(totalAsset).toLocaleString();
            const netAsset = totalAsset - house - credit;
            const netAssetExclHouse = totalAsset - house;
            const diff = netAssetExclHouse - lastMonthNetExclHouse;
            document.getElementById('res-net').innerText = Math.floor(netAsset).toLocaleString();
            document.getElementById('res-excl').innerText = Math.floor(netAssetExclHouse).toLocaleString();
            const diffEl = document.getElementById('res-diff');
            diffEl.innerText = Math.floor(diff).toLocaleString();
            diffEl.className = "font-mono text-sm font-bold " + (diff >= 0 ? "text-emerald-400" : "text-red-400");
        }

        async function saveData() {
            const status = document.getElementById('sync-status');
            if(status) status.innerText = "同步中...";
            const data = {
                you_banks: Array.from(document.querySelectorAll('#you-bank-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                ling_banks: Array.from(document.querySelectorAll('#ling-bank-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                house_loans: Array.from(document.querySelectorAll('#loan-house-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                credit_loans: Array.from(document.querySelectorAll('#loan-credit-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                stocks: { you_tw: document.getElementById('you-stock-tw').value, you_us: document.getElementById('you-stock-us').value, ling_1: document.getElementById('ling-stock-1').value, ling_2: document.getElementById('ling-stock-2').value }
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                if(status) { status.innerText = "已成功儲存並更新"; setTimeout(() => status.innerText = "系統就緒", 2000); }
            } catch (e) { if(status) status.innerText = "儲存失敗"; }
        }

        async function archiveHistory() {
            if (!confirm("確認結算本月數據？系統將會先自動儲存當前明細。")) return;
            const status = document.getElementById('sync-status');
            if(status) status.innerText = "自動儲存中...";
            try {
                // 先儲存明細
                const currentData = {
                    you_banks: Array.from(document.querySelectorAll('#you-bank-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                    ling_banks: Array.from(document.querySelectorAll('#ling-bank-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                    house_loans: Array.from(document.querySelectorAll('#loan-house-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                    credit_loans: Array.from(document.querySelectorAll('#loan-credit-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
                    stocks: { you_tw: document.getElementById('you-stock-tw').value, you_us: document.getElementById('you-stock-us').value, ling_1: document.getElementById('ling-stock-1').value, ling_2: document.getElementById('ling-stock-2').value }
                };
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(currentData) });
                
                // 執行結算
                const payload = {
                    action: 'ARCHIVE_HISTORY',
                    date: document.getElementById('archive-date').value || new Date().toISOString().slice(0, 10),
                    totalAsset: document.getElementById('global-asset-sum').innerText.replace(/,/g, ''),
                    totalBank: document.getElementById('global-bank-sum').innerText.replace(/,/g, ''),
                    netAsset: document.getElementById('res-net').innerText.replace(/,/g, ''),
                    netAssetExclHouse: document.getElementById('res-excl').innerText.replace(/,/g, ''),
                    diff: document.getElementById('res-diff').innerText.replace(/,/g, ''),
                    fxRate: currentFxRate.toFixed(3),
                    youTotal: document.getElementById('you-total').innerText.replace(/,/g, ''),
                    lingTotal: document.getElementById('ling-total').innerText.replace(/,/g, ''),
                    note: document.getElementById('archive-note').value
                };
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("儲存並結算成功！");
                location.reload();
            } catch (e) { alert("結算失敗"); }
        }

        async function loadHistoryTable() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-10">載入中...</td></tr>';
            try {
                const response = await fetch(`${GAS_URL}?action=readHistory`);
                const rows = await response.json();
                fetchedHistory = rows; 
                if (rows.length <= 1) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-10">無紀錄</td></tr>'; return; }
                tbody.innerHTML = '';
                rows.slice(1).reverse().forEach(row => {
                    let d = String(row[0]); 
                    if(d.includes('T')) d = d.split('T')[0];
                    const displayDate = d.slice(2); 
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="日期" class="text-white font-bold">${displayDate}</td>
                        <td data-label="總資產" class="text-white font-bold">${row[1]}</td>
                        <td data-label="存款" class="text-emerald-400">${row[2]}</td>
                        <td data-label="淨資產(扣所有)" class="text-blue-400">${row[3]}</td>
                        <td data-label="淨資產(扣房貸)" class="text-emerald-500 font-bold">${row[4]}</td>
                        <td data-label="增減" class="${String(row[5]).includes('-') ? 'text-red-400' : 'text-emerald-400'} font-bold">${row[5]}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-400 py-10">讀取失敗</td></tr>'; }
        }

        // --- 核心匯出 Excel 功能 ---
        function exportToExcel() {
            if (fetchedHistory.length === 0) { alert("請先點擊重新整理歷史紀錄"); return; }
            const wb = XLSX.utils.book_new();
            
            // 1. 每月結算趨勢表 (仿範本 1)
            const year = new Date().getFullYear();
            // 按日期排序 (從舊到新)
            const sortedHistory = fetchedHistory.slice(1).sort((a,b) => new Date(a[0]) - new Date(b[0]));
            
            const summaryRows = [
                [`${year}年 財務趨勢報告 (字體: 微軟正黑體)`],
                ["月份", ...sortedHistory.map(r => (new Date(r[0]).getMonth()+1) + "月")],
                ["本月實際餘額", ...sortedHistory.map(r => Number(r[1]))],
                ["本月淨資產(扣除所有)", ...sortedHistory.map(r => Number(r[3]))],
                ["本月現金(存款總計)", ...sortedHistory.map(r => Number(r[2]))],
                ["扣房貸淨資產", ...sortedHistory.map(r => Number(r[4]))],
                ["淨資產增減", ...sortedHistory.map(r => r[5])],
                ["美金匯率", ...sortedHistory.map(r => r[6] || "-")], // 第 7 欄
                ["猷 個人總計 (含美股)", ...sortedHistory.map(r => r[7] || "-")], // 第 8 欄
                ["玲 個人總計", ...sortedHistory.map(r => r[8] || "-")], // 第 9 欄
                ["備註說明", ...sortedHistory.map(r => r[9] || "")]  // 第 10 欄
            ];
            
            const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
            
            // 樣式調整 (欄寬)
            wsSum['!cols'] = [{ wch: 22 }, ...sortedHistory.map(() => ({ wch: 15 }))];
            
            XLSX.utils.book_append_sheet(wb, wsSum, "每月結算趨勢");

            // 2. 當前明細快照 (仿範本 2)
            const detailData = [
                ["猷 (個人資產清單)", "", "", "玲 (個人資產清單)", "", "", "貸款與指標狀態"],
                ["項目名稱", "金額 (TWD/USD)", "個人總計", "項目名稱", "金額 (TWD)", "個人總計", "項目/指標", "數值"],
            ];

            const youList = Array.from(document.querySelectorAll('#you-bank-list > div')).map(d => [d.querySelector('.item-name').value, Number(d.querySelector('.item-amount').value)]);
            youList.push(["台股市值", Number(document.getElementById('you-stock-tw').value)]);
            youList.push(["美股市值 (USD)", Number(document.getElementById('you-stock-us').value)]);

            const lingList = Array.from(document.querySelectorAll('#ling-bank-list > div')).map(d => [d.querySelector('.item-name').value, Number(d.querySelector('.item-amount').value)]);
            lingList.push(["台股市值", Number(document.getElementById('ling-stock-1').value)]);
            lingList.push(["配股市值", Number(document.getElementById('ling-stock-2').value)]);

            const indicatorList = [
                ["房貸總計", document.getElementById('loan-house-sum').innerText],
                ["信貸總計", document.getElementById('loan-credit-sum').innerText],
                ["總資產", document.getElementById('global-asset-sum').innerText],
                ["總存款", document.getElementById('global-bank-sum').innerText],
                ["美金匯率參考", currentFxRate.toFixed(3)],
                ["結算日期", document.getElementById('archive-date').value]
            ];

            const maxLen = Math.max(youList.length, lingList.length, indicatorList.length);
            for(let i=0; i<maxLen; i++) {
                detailData.push([
                    youList[i]?.[0] || "", youList[i]?.[1] || "", (i===0 ? document.getElementById('you-total').innerText : ""),
                    lingList[i]?.[0] || "", lingList[i]?.[1] || "", (i===0 ? document.getElementById('ling-total').innerText : ""),
                    indicatorList[i]?.[0] || "", indicatorList[i]?.[1] || ""
                ]);
            }

            const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
            wsDetail['!cols'] = [{wch:18}, {wch:15}, {wch:15}, {wch:18}, {wch:15}, {wch:15}, {wch:18}, {wch:15}];
            XLSX.utils.book_append_sheet(wb, wsDetail, "資產明細快照");

            XLSX.writeFile(wb, `猷玲財務報表_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        async function loadData() {
            try {
                const response = await fetch(GAS_URL);
                const res = await response.json();
                lastMonthNetExclHouse = res.lastMonthNetExclHouse || 0;
                document.getElementById('last-month-val').innerText = lastMonthNetExclHouse.toLocaleString();
                const data = res.currentState || {};
                if (data.you_banks?.length) data.you_banks.forEach(b => addRow('you-bank-list', '銀行', b.name, b.amount));
                if (data.ling_banks?.length) data.ling_banks.forEach(b => addRow('ling-bank-list', '銀行', b.name, b.amount));
                if (data.house_loans?.length) data.house_loans.forEach(l => addRow('loan-house-list', '名稱', l.name, l.amount));
                if (data.credit_loans?.length) data.credit_loans.forEach(l => addRow('loan-credit-list', '名稱', l.name, l.amount));
                if (data.stocks) {
                    document.getElementById('you-stock-tw').value = data.stocks.you_tw || '';
                    document.getElementById('you-stock-us').value = data.stocks.you_us || '';
                    document.getElementById('ling-stock-1').value = data.stocks.ling_1 || '';
                    document.getElementById('ling-stock-2').value = data.stocks.ling_2 || '';
                }
            } catch (e) { console.error(e); }
            initSortable('you-bank-list'); initSortable('ling-bank-list');
            initSortable('loan-house-list'); initSortable('loan-credit-list');
            document.getElementById('archive-date').value = new Date().toISOString().slice(0, 10);
            calculate();
        }
        window.onload = () => { fetchFxRate(); loadData(); };
    </script>
</body>
</html>
