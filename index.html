<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猷 & 玲 總資產管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 0.875rem; }
        .section-title { font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; border-left: 3px solid #3b82f6; padding-left: 8px; margin-bottom: 12px; }
        .btn-action { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.4); color: #60a5fa; padding: 6px 16px; border-radius: 99px; font-size: 0.75rem; transition: all 0.3s; font-weight: 600; }
        .btn-action:hover { background: #3b82f6; color: white; }
        .btn-add { background: rgba(255, 255, 255, 0.05); color: #94a3b8; border: 1px solid rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 10px; }
        .btn-delete { color: #ef4444; cursor: pointer; padding: 0 8px; }
        .drag-handle { color: #475569; cursor: grab; padding: 0 4px; font-size: 14px; user-select: none; }
        .usd-label { font-size: 10px; color: #60a5fa; margin-top: 2px; padding-right: 32px; text-align: right; width: 100%; display: block; font-family: monospace; }
        .stock-label { font-size: 9px; color: #94a3b8; margin-bottom: 4px; display: block; font-weight: bold; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-online { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
        #history-container table { width: 100%; border-collapse: collapse; }
        #history-container th, #history-container td { padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .hidden { display: none; }
    </style>
</head>
<body class="gradient-bg text-slate-200 min-h-screen p-4 md:p-8 font-sans">
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/10 pb-8 gap-8">
            <div class="flex flex-col items-center md:items-start">
                <h1 class="text-xl font-bold tracking-widest text-white mb-2">猷 & 玲 總資產管理系統</h1>
                <div class="flex items-center gap-6">
                    <button onclick="togglePage('edit')" id="nav-edit" class="text-xs font-bold text-blue-400 border-b-2 border-blue-400 pb-1">資產編輯</button>
                    <button onclick="togglePage('history')" id="nav-history" class="text-xs font-bold text-slate-500 hover:text-white pb-1">歷史紀錄</button>
                </div>
            </div>
            <div class="flex gap-12">
                <div class="text-center">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1 tracking-wider">現有存款</span>
                    <span id="global-bank-sum" class="text-2xl font-mono font-bold text-emerald-400">0</span>
                </div>
                <div class="text-center">
                    <span class="text-[10px] text-blue-300 uppercase block mb-1 tracking-wider">現有總資產</span>
                    <span id="global-asset-sum" class="text-2xl font-mono font-bold text-white">0</span>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <div class="text-center mb-4"> 
                    <span class="text-[10px] text-slate-500 uppercase block mb-0.5 tracking-wider">USD/TWD 參考匯率</span>
                    <span id="fx-rate-display" class="text-lg text-white font-mono font-bold">--.--</span>
                </div>
                <button onclick="saveData()" class="btn-action tracking-widest uppercase px-10">儲存並更新</button>
            </div>
        </header>

        <div id="page-edit" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white tracking-widest">猷 (資產明細)</h2>
                    <span id="you-total" class="font-mono text-white font-bold text-lg">0</span>
                </div>
                <div class="section-title">銀行存款 / 現金</div>
                <div id="you-bank-list" class="space-y-2 mb-4"></div>
                <button onclick="addRow('you-bank-list')" class="btn-add">+ 新增銀行</button>
                <div class="section-title mt-8">股票庫存</div>
                <div class="grid grid-cols-2 gap-4">
                    <div><span class="stock-label">台股市值 (TWD)</span><input type="number" id="you-stock-tw" class="input-field font-mono" oninput="calculate()"></div>
                    <div><span class="stock-label">美股市值 (USD)</span><input type="number" id="you-stock-us" class="input-field font-mono text-blue-400" oninput="calculate()"></div>
                </div>
            </div>

            <div class="card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white tracking-widest">玲 (資產明細)</h2>
                    <span id="ling-total" class="font-mono text-white font-bold text-lg">0</span>
                </div>
                <div class="section-title">銀行存款 / 現金</div>
                <div id="ling-bank-list" class="space-y-2 mb-4"></div>
                <button onclick="addRow('ling-bank-list')" class="btn-add">+ 新增銀行</button>
                <div class="section-title mt-8">投資項目</div>
                <div class="grid grid-cols-2 gap-4">
                    <div><span class="stock-label">台股市值 (TWD)</span><input type="number" id="ling-stock-1" class="input-field font-mono" oninput="calculate()"></div>
                    <div><span class="stock-label">其他股票/投資</span><input type="number" id="ling-stock-2" class="input-field font-mono" oninput="calculate()"></div>
                </div>
            </div>

            <div class="lg:col-span-2 card p-6 rounded-2xl border-t-2 border-red-500/50">
                <h2 class="text-xs font-bold text-white tracking-widest mb-6 uppercase">負債明細管理 (貸款)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div class="flex justify-between items-center mb-2"><span class="text-[10px] text-slate-500">房貸</span><span id="loan-house-sum" class="font-mono text-red-400">0</span></div>
                        <div id="loan-house-list" class="space-y-2"></div>
                        <button onclick="addRow('loan-house-list', '房貸名稱')" class="btn-add mt-2">+ 房貸</button>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2"><span class="text-[10px] text-slate-500">其他貸款 (信貸/青創/媽)</span><span id="loan-credit-sum" class="font-mono text-red-400">0</span></div>
                        <div id="loan-credit-list" class="space-y-2"></div>
                        <button onclick="addRow('loan-credit-list', '項目名稱')" class="btn-add mt-2">+ 其他貸款</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 card p-6 rounded-2xl border-t-2 border-emerald-500/50">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-xs font-bold text-white tracking-widest uppercase">年底/月底 結算存檔</h2>
                    <input type="date" id="archive-date" class="bg-transparent text-white font-mono text-xs outline-none">
                </div>
                <textarea id="archive-note" class="input-field w-full h-16 text-xs bg-black/20 mb-4" placeholder="填寫本月重大支出或備註 (例如：出國旅遊、大額開銷)"></textarea>
                <div class="flex justify-center">
                    <button onclick="archiveHistory()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-12 py-3 rounded-xl text-sm font-black tracking-widest">確認結算並儲存至歷史</button>
                </div>
            </div>
        </div>

        <div id="page-history" class="hidden">
            <div class="card p-6 rounded-2xl" id="history-container">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white tracking-widest">財務歷史報表</h2>
                    <button onclick="exportFullExcel()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg text-xs font-bold tracking-widest">匯出完整 EXCEL 報表</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="history-table">
                        <thead>
                            <tr class="text-slate-500 text-[10px] uppercase">
                                <th>日期</th><th>總資產</th><th>現金</th><th>淨資產(扣所有)</th><th>淨資產(扣房貸)</th><th>增減</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="font-mono text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzT-nQswx9GUQ8JHEp1zpr4HDXSHrz7s8kTqIe3FD9eUzqqNb7UlBGnSGoLqInyQ3i1/exec'; 
        let currentFxRate = 32.5;
        let fetchedHistory = [];

        // 初始化
        window.onload = () => {
            fetchFxRate();
            loadData();
            initSortable('you-bank-list');
            initSortable('ling-bank-list');
        };

        function initSortable(id) {
            new Sortable(document.getElementById(id), { animation: 150, onEnd: () => calculate() });
        }

        function togglePage(page) {
            const isHistory = (page === 'history');
            document.getElementById('page-edit').classList.toggle('hidden', isHistory);
            document.getElementById('page-history').classList.toggle('hidden', !isHistory);
            if (isHistory) loadHistoryTable();
        }

        async function fetchFxRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                currentFxRate = data.rates.TWD;
                document.getElementById('fx-rate-display').innerText = currentFxRate.toFixed(2);
                calculate();
            } catch (e) { document.getElementById('fx-rate-display').innerText = "32.50"; }
        }

        function addRow(containerId, placeholder = '銀行名稱', name = '', amount = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center mb-2";
            div.innerHTML = `
                <input type="text" class="input-field text-xs item-name" value="${name}" placeholder="${placeholder}">
                <input type="number" class="input-field w-32 font-mono text-right text-xs item-amount" value="${amount}" placeholder="金額" oninput="calculate()">
                <span class="btn-delete" onclick="this.parentElement.remove(); calculate();">✕</span>
            `;
            container.appendChild(div);
            calculate();
        }

        function calculate() {
            let youBank = 0;
            document.querySelectorAll('#you-bank-list div').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const val = parseFloat(row.querySelector('.item-amount').value) || 0;
                youBank += name.includes("美金") ? val * currentFxRate : val;
            });

            const youStock = (parseFloat(document.getElementById('you-stock-tw').value) || 0) + 
                             ((parseFloat(document.getElementById('you-stock-us').value) || 0) * currentFxRate);
            const youTotal = youBank + youStock;
            document.getElementById('you-total').innerText = Math.floor(youTotal).toLocaleString();

            let lingBank = 0;
            document.querySelectorAll('#ling-bank-list div').forEach(row => {
                lingBank += parseFloat(row.querySelector('.item-amount').value) || 0;
            });
            const lingStock = (parseFloat(document.getElementById('ling-stock-1').value) || 0) + (parseFloat(document.getElementById('ling-stock-2').value) || 0);
            const lingTotal = lingBank + lingStock;
            document.getElementById('ling-total').innerText = Math.floor(lingTotal).toLocaleString();

            let house = 0; document.querySelectorAll('#loan-house-list .item-amount').forEach(el => house += parseFloat(el.value) || 0);
            let credit = 0; document.querySelectorAll('#loan-credit-list .item-amount').forEach(el => credit += parseFloat(el.value) || 0);
            
            document.getElementById('loan-house-sum').innerText = Math.floor(house).toLocaleString();
            document.getElementById('loan-credit-sum').innerText = Math.floor(credit).toLocaleString();
            document.getElementById('global-bank-sum').innerText = Math.floor(youBank + lingBank).toLocaleString();
            document.getElementById('global-asset-sum').innerText = Math.floor(youTotal + lingTotal).toLocaleString();
        }

        // --- 核心功能：匯出與圖片範本一致的 Excel ---
        function exportFullExcel() {
            if (fetchedHistory.length === 0) { alert("請先切換至歷史紀錄頁面讀取資料"); return; }
            const wb = XLSX.utils.book_new();

            // 1. 第二個分頁：年度結算趨勢 (橫向 1-12 月)
            const sortedHistory = fetchedHistory.slice(1).sort((a, b) => new Date(a[0]) - new Date(b[0]));
            const summaryRows = [
                [`2025年 財務記錄統計`],
                ["月份", ...sortedHistory.map(r => (new Date(r[0]).getMonth() + 1) + "月")],
                ["本月實際餘額", ...sortedHistory.map(r => Number(r[1]) || 0)],
                ["本月淨資產", ...sortedHistory.map(r => Number(r[3]) || 0)],
                ["本月現金", ...sortedHistory.map(r => Number(r[2]) || 0)],
                ["扣房貸淨資產", ...sortedHistory.map(r => Number(r[4]) || 0)],
                ["淨資產增減", ...sortedHistory.map(r => Number(r[5]) || 0)],
                ["美金匯率", ...sortedHistory.map(r => Number(r[6]) || "")],
                ["備註", ...sortedHistory.map(r => r[9] || "")]
            ];
            const wsSum = XLSX.utils.aoa_to_sheet(summaryRows);
            XLSX.utils.book_append_sheet(wb, wsSum, "每月結算統計表");

            // 2. 第一個分頁：當前明細 (比照範本一排版)
            const detailRows = [
                ["【個人資產明細】", "", "", "【負債/貸款明細】", "", "【資產總計】"],
                ["項目 (猷)", "金額", "", "項目名稱", "金額", "項目", "數值"],
            ];

            const youData = Array.from(document.querySelectorAll('#you-bank-list div')).map(d => [d.querySelector('.item-name').value, d.querySelector('.item-amount').value]);
            const lingData = Array.from(document.querySelectorAll('#ling-bank-list div')).map(d => [d.querySelector('.item-name').value, d.querySelector('.item-amount').value]);
            const loanData = [
                ...Array.from(document.querySelectorAll('#loan-house-list div')).map(d => [d.querySelector('.item-name').value, d.querySelector('.item-amount').value]),
                ...Array.from(document.querySelectorAll('#loan-credit-list div')).map(d => [d.querySelector('.item-name').value, d.querySelector('.item-amount').value])
            ];

            const maxRows = Math.max(youData.length + lingData.length + 5, loanData.length + 5);
            for(let i=0; i<maxRows; i++) {
                let row = Array(7).fill("");
                // 左側：資產
                if(i < youData.length) { row[0] = youData[i][0]; row[1] = Number(youData[i][1]); }
                else if (i === youData.length) { row[0] = "---(玲)---"; }
                else if (i > youData.length && i <= youData.length + lingData.length) { 
                    const idx = i - youData.length - 1;
                    row[0] = lingData[idx][0]; row[1] = Number(lingData[idx][1]);
                }
                // 中間：貸款
                if(i < loanData.length) { row[3] = loanData[i][0]; row[4] = Number(loanData[i][1]); }
                // 右側：總覽
                if(i === 0) { row[5] = "現有存款"; row[6] = document.getElementById('global-bank-sum').innerText; }
                if(i === 1) { row[5] = "現有總資產"; row[6] = document.getElementById('global-asset-sum').innerText; }
                if(i === 2) { row[5] = "美金匯率"; row[6] = currentFxRate.toFixed(3); }

                detailRows.push(row);
            }
            const wsDetail = XLSX.utils.aoa_to_sheet(detailRows);
            XLSX.utils.book_append_sheet(wb, wsDetail, "資產負債明細");

            XLSX.writeFile(wb, `猷玲財務報表_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        async function archiveHistory() {
            if (!confirm("確定要結算本月數據嗎？")) return;
            const payload = {
                action: 'ARCHIVE_HISTORY',
                date: document.getElementById('archive-date').value || new Date().toISOString().slice(0, 10),
                totalAsset: document.getElementById('global-asset-sum').innerText.replace(/,/g, ''),
                totalBank: document.getElementById('global-bank-sum').innerText.replace(/,/g, ''),
                fxRate: currentFxRate.toFixed(3),
                note: document.getElementById('archive-note').value
            };
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("結算成功");
            location.reload();
        }

        async function loadHistoryTable() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '載入中...';
            const response = await fetch(`${GAS_URL}?action=readHistory`);
            const rows = await response.json();
            fetchedHistory = rows;
            tbody.innerHTML = '';
            rows.slice(1).reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row[0].slice(5,10)}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td>`;
                tbody.appendChild(tr);
            });
        }

        async function loadData() {
            const response = await fetch(GAS_URL);
            const res = await response.json();
            const data = res.currentState || {};
            if (data.you_banks) data.you_banks.forEach(b => addRow('you-bank-list', '銀行', b.name, b.amount));
            if (data.ling_banks) data.ling_banks.forEach(b => addRow('ling-bank-list', '銀行', b.name, b.amount));
            calculate();
        }
    </script>
</body>
</html>
