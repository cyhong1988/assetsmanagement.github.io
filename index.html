<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猷 & 玲 總資產管理系統 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: white; padding: 6px 10px; border-radius: 6px; width: 100%; font-size: 0.875rem; }
        .input-readonly { background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(51, 65, 85, 0.3); color: #94a3b8; cursor: not-allowed; }
        .btn-delete { color: #ef4444; cursor: pointer; padding: 0 8px; font-weight: bold; }
        .btn-add { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; transition: all 0.2s; }
        .btn-add:hover { background: rgba(59, 130, 246, 0.3); color: white; }
        .section-title { font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; border-left: 3px solid #3b82f6; padding-left: 8px; margin-bottom: 12px; }
        
        .btn-save { 
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.4); 
            color: #60a5fa; 
            padding: 8px 24px; 
            border-radius: 99px; 
            font-size: 0.75rem; 
            letter-spacing: 0.2em;
            transition: all 0.3s; 
            font-weight: 600;
        }
        .btn-save:hover { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    </style>
</head>
<body class="gradient-bg text-slate-200 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/10 pb-8 gap-6">
            <div class="flex-1">
                <h1 class="text-xl font-bold tracking-widest text-white">資產管理系統</h1>
                <div class="flex items-center gap-2 mt-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p id="sync-status" class="text-slate-500 text-[10px] tracking-widest uppercase font-semibold">系統連線中</p>
                </div>
            </div>

            <div class="flex gap-8">
                <div class="text-center">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1">現有存款</span>
                    <span id="global-bank-sum" class="text-2xl font-mono font-bold text-emerald-400">0</span>
                </div>
                <div class="text-center">
                    <span class="text-[10px] text-blue-300 uppercase block mb-1">現有總資產</span>
                    <span id="global-asset-sum" class="text-2xl font-mono font-bold text-white">0</span>
                </div>
            </div>

            <div class="flex-1 flex flex-col items-center md:items-end gap-2">
                <div class="text-[10px] text-slate-500 uppercase">USD/TWD: <span id="fx-rate-display">--.--</span></div>
                <button onclick="saveData()" class="btn-save uppercase">儲存並同步雲端</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white tracking-widest">【 猷 】</h2>
                    <span class="text-[10px] text-slate-500 font-mono">Total: <span id="you-total" class="text-white">0</span></span>
                </div>
                <div class="section-title">銀行存款</div>
                <div id="you-bank-list" class="space-y-2 mb-4"></div>
                <button onclick="addRow('you-bank-list')" class="btn-add">+ 新增銀行</button>

                <div class="section-title mt-6">股票庫存</div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase block">台股 (TWD)</label>
                        <input type="number" id="you-stock-tw" class="input-field font-mono" value="0" oninput="calculate()">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase block">美股 (USD)</label>
                        <input type="number" id="you-stock-us" class="input-field font-mono text-blue-400" value="0" oninput="calculate()">
                        <div class="text-[9px] text-slate-500 mt-1">≈ <span id="you-stock-us-twd">0</span> TWD</div>
                    </div>
                </div>
            </div>

            <div class="card p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-white tracking-widest">【 玲 】</h2>
                    <span class="text-[10px] text-slate-500 font-mono">Total: <span id="ling-total" class="text-white">0</span></span>
                </div>
                <div class="section-title">銀行存款</div>
                <div id="ling-bank-list" class="space-y-2 mb-4"></div>
                <button onclick="addRow('ling-bank-list')" class="btn-add">+ 新增銀行</button>

                <div class="section-title mt-6">股票庫存</div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase block">股票庫存 (TWD)</label>
                        <input type="number" id="ling-stock-1" class="input-field font-mono" value="0" oninput="calculate()">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase block">雄獅股票 (TWD)</label>
                        <input type="number" id="ling-stock-2" class="input-field font-mono" value="0" oninput="calculate()">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 card p-6 rounded-2xl border-t-2 border-red-500/50">
                <h2 class="text-sm font-bold text-white tracking-widest mb-6">貸款管理 (房貸 & 信貸)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div class="section-title !mb-0">房貸</div>
                            <span class="text-xs font-mono text-red-400" id="loan-house-sum">0</span>
                        </div>
                        <div id="loan-house-list" class="space-y-2 mb-4"></div>
                        <button onclick="addRow('loan-house-list', '房貸名稱')" class="btn-add">+ 筆數</button>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div class="section-title !mb-0">信貸</div>
                            <span class="text-xs font-mono text-red-400" id="loan-credit-sum">0</span>
                        </div>
                        <div id="loan-credit-list" class="space-y-2 mb-4"></div>
                        <button onclick="addRow('loan-credit-list', '信貸名稱')" class="btn-add">+ 筆數</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzT-nQswx9GUQ8JHEp1zpr4HDXSHrz7s8kTqIe3FD9eUzqqNb7UlBGnSGoLqInyQ3i1/exec'; 
        let currentFxRate = 32.5;

        async function fetchFxRate() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if (data && data.rates.TWD) {
                    currentFxRate = data.rates.TWD;
                    document.getElementById('fx-rate-display').innerText = currentFxRate.toFixed(2);
                    calculate();
                }
            } catch (e) { document.getElementById('fx-rate-display').innerText = "32.50 (估)"; }
        }

        function addRow(containerId, placeholder = '項目名稱', name = '', amount = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center mb-2";
            div.innerHTML = `
                <input type="text" class="input-field text-xs item-name" value="${name}" placeholder="${placeholder}">
                <input type="number" class="input-field w-32 font-mono text-right text-xs item-amount" value="${amount}" oninput="calculate()">
                <span class="btn-delete" onclick="this.parentElement.remove(); calculate();">✕</span>
            `;
            container.appendChild(div);
            calculate();
        }

        function calculate() {
            // 猷 計算
            let youBankSum = 0;
            document.querySelectorAll('#you-bank-list .item-amount').forEach(el => youBankSum += parseFloat(el.value) || 0);
            const youStockTW = parseFloat(document.getElementById('you-stock-tw').value) || 0;
            const youStockUS = parseFloat(document.getElementById('you-stock-us').value) || 0;
            const youStockUS_TWD = youStockUS * currentFxRate;
            document.getElementById('you-stock-us-twd').innerText = Math.floor(youStockUS_TWD).toLocaleString();
            const youTotal = youBankSum + youStockTW + youStockUS_TWD;
            document.getElementById('you-total').innerText = Math.floor(youTotal).toLocaleString();

            // 玲 計算
            let lingBankSum = 0;
            document.querySelectorAll('#ling-bank-list .item-amount').forEach(el => lingBankSum += parseFloat(el.value) || 0);
            const lingStock1 = parseFloat(document.getElementById('ling-stock-1').value) || 0;
            const lingStock2 = parseFloat(document.getElementById('ling-stock-2').value) || 0;
            const lingTotal = lingBankSum + lingStock1 + lingStock2;
            document.getElementById('ling-total').innerText = Math.floor(lingTotal).toLocaleString();

            // 貸款
            let houseSum = 0; document.querySelectorAll('#loan-house-list .item-amount').forEach(el => houseSum += parseFloat(el.value) || 0);
            document.getElementById('loan-house-sum').innerText = houseSum.toLocaleString();
            let creditSum = 0; document.querySelectorAll('#loan-credit-list .item-amount').forEach(el => creditSum += parseFloat(el.value) || 0);
            document.getElementById('loan-credit-sum').innerText = creditSum.toLocaleString();

            // 總結
            document.getElementById('global-bank-sum').innerText = Math.floor(youBankSum + lingBankSum).toLocaleString();
            document.getElementById('global-asset-sum').innerText = Math.floor(youTotal + lingTotal).toLocaleString();
        }

        async function saveData() {
    const status = document.getElementById('sync-status');
    status.innerText = "儲存中...";
    
    const data = {
        type: 'ASSET_SYSTEM', // 新增標籤，讓 GAS 辨識
        you_banks: Array.from(document.querySelectorAll('#you-bank-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
        ling_banks: Array.from(document.querySelectorAll('#ling-bank-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
        house_loans: Array.from(document.querySelectorAll('#loan-house-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
        credit_loans: Array.from(document.querySelectorAll('#loan-credit-list > div')).map(d => ({ name: d.querySelector('.item-name').value, amount: d.querySelector('.item-amount').value })),
        stocks: {
            you_tw: document.getElementById('you-stock-tw').value,
            you_us: document.getElementById('you-stock-us').value,
            ling_1: document.getElementById('ling-stock-1').value,
            ling_2: document.getElementById('ling-stock-2').value
        }
    };

    try {
        // 使用 POST 傳送
        await fetch(GAS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(data) 
        });
        status.innerText = "同步完成";
        setTimeout(() => status.innerText = "系統連線中", 3000);
    } catch (e) { status.innerText = "儲存失敗"; }
}


        async function loadData() {
            const status = document.getElementById('sync-status');
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                if (data) {
                    // 清空並重新填入
                    document.getElementById('you-bank-list').innerHTML = '';
                    document.getElementById('ling-bank-list').innerHTML = '';
                    document.getElementById('loan-house-list').innerHTML = '';
                    document.getElementById('loan-credit-list').innerHTML = '';

                    if(data.you_banks) data.you_banks.forEach(b => addRow('you-bank-list', '銀行', b.name, b.amount));
                    if(data.ling_banks) data.ling_banks.forEach(b => addRow('ling-bank-list', '銀行', b.name, b.amount));
                    if(data.house_loans) data.house_loans.forEach(b => addRow('loan-house-list', '名稱', b.name, b.amount));
                    if(data.credit_loans) data.credit_loans.forEach(b => addRow('loan-credit-list', '名稱', b.name, b.amount));
                    
                    if(data.stocks) {
                        document.getElementById('you-stock-tw').value = data.stocks.you_tw || 0;
                        document.getElementById('you-stock-us').value = data.stocks.you_us || 0;
                        document.getElementById('ling-stock-1').value = data.stocks.ling_1 || 0;
                        document.getElementById('ling-stock-2').value = data.stocks.ling_2 || 0;
                    }
                }
            } catch (e) {
                // 如果失敗則初始化預設名單
                const b1 = ["中信", "新光", "Richart", "台新外幣", "元大", "國泰CUBE", "王道", "玉山", "樂天", "永豐大戶", "上海商銀", "美金定存"];
                const b2 = ["中信", "玉山", "Richart", "永豐大戶", "樂天", "玲媽未投"];
                b1.forEach(n => addRow('you-bank-list', '銀行', n, 0));
                b2.forEach(n => addRow('ling-bank-list', '銀行', n, 0));
                addRow('loan-house-list', '房貸', '房貸1', 0);
                addRow('loan-credit-list', '信貸', '信貸1', 0);
            }
            calculate();
        }

        window.onload = () => { fetchFxRate(); loadData(); };
    </script>
</body>
</html>

